<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IDV Assignment 4 – Robust Accuracy (Metric-wise View)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- 蓝色系样式，三大类按按钮切换，柱子按 4 个数据集分组 -->
  <style>
    :root{
      --bg: #050816;
      --card-bg: #0d1630;
      --card-border: #1e2a4a;
      --accent: #4da3ff;
      --accent-soft: #173459;
      --text-main: #e5f0ff;
      --text-muted: #9fb3d4;
      --grid-line: #32446d;
      /* 数据集颜色（全是蓝色系不同深浅） */
      --cifar100: #9fd1ff;
      --cifar10:  #6fb1ff;
      --svhn:     #3d82f2;
      --mnist:    #214070;
      --tooltip-bg: #111827;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #081534, #020617);
      color:var(--text-main);
    }

    .page{
      max-width:1100px;
      margin:0 auto;
      padding:24px 16px 40px;
    }

    h1{
      margin:0 0 8px;
      font-weight:600;
      letter-spacing:0.02em;
    }

    .subtitle{
      margin:0 0 20px;
      color:var(--text-muted);
      font-size:0.96rem;
    }

    .chart-card{
      margin-top:12px;
      background:radial-gradient(circle at top left,#15213f,#060b1c);
      border-radius:18px;
      border:1px solid var(--card-border);
      box-shadow:0 20px 40px rgba(0,0,0,0.45);
      padding:16px 16px 20px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }

    .metric-toggle{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .metric-btn{
      border-radius:999px;
      border:1px solid transparent;
      background:var(--accent-soft);
      color:var(--text-main);
      padding:6px 14px;
      font-size:0.85rem;
      cursor:pointer;
      transition:all .18s ease;
    }

    .metric-btn:hover{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(77,163,255,0.24);
    }

    .metric-btn.active{
      background:var(--accent);
      color:#020617;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(15,118,255,0.8),0 0 20px rgba(56,189,248,0.35);
    }

    .hint{
      margin:0 0 0 4px;
      font-size:0.8rem;
      color:var(--text-muted);
    }

    svg{
      display:block;
      width:100%;
      height:auto;
    }

    .axis text{
      fill:var(--text-muted);
      font-size:12px;
    }

    .axis path,
    .axis line{
      stroke:#44557a;
      stroke-width:1;
      shape-rendering:crispEdges;
    }

    .y-axis .domain{
      display:none;
    }

    .grid line{
      stroke:var(--grid-line);
      stroke-opacity:0.35;
      stroke-dasharray:3,4;
    }

    .axis-label{
      fill:var(--text-muted);
      font-size:12px;
    }

    .title-main{
      font-size:0.95rem;
      font-weight:500;
      margin:0 0 4px;
      color:var(--text-main);
    }

    .title-secondary{
      margin:0;
      color:var(--text-muted);
      font-size:0.8rem;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      font-size:0.8rem;
      color:var(--text-muted);
    }

    .legend-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .legend-swatch{
      width:14px;
      height:14px;
      border-radius:4px;
      background:#fff;
    }

    .bar{
      cursor:pointer;
      transition:opacity .12s ease;
    }

    .bar:hover{
      opacity:0.9;
    }

    .tooltip{
      position:absolute;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--text-main);
      font-size:0.78rem;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 15px 35px rgba(15,23,42,0.7);
      opacity:0;
      transform:translateY(-4px);
      transition:opacity .12s ease, transform .12s ease;
      z-index:20;
      white-space:nowrap;
    }

    .tooltip-title{
      font-weight:600;
      margin-bottom:2px;
    }

    .notes{
      margin-top:18px;
      font-size:0.84rem;
      color:var(--text-muted);
      line-height:1.6;
    }

    .notes h2{
      font-size:0.9rem;
      margin:0 0 4px;
      color:var(--text-main);
    }

    .notes ul{
      margin:4px 0 0 18px;
      padding:0;
    }

    .notes li{
      margin-bottom:2px;
    }
  </style>
</head>
<body>
  <main class="page">
    <h1>Interactive Robust Accuracy (Metric-wise Grouped View)</h1>
    <p class="subtitle">
      Data source: Excel results of 9 approaches × 4 datasets × 3 metrics.
      Here we group and view data by three main metric categories:
      <strong>Standard Accuracy</strong>,
      <strong>Certified Robustness Rate</strong>,
      <strong>Certified Robust Accuracy</strong>.
    </p>

    <!-- 顶部：三大类指标切换 -->
    <section class="controls">
      <div class="metric-toggle" id="metricToggle"></div>
      <p class="hint">Click a metric category to switch view · Bars are grouped by datasets within each approach.</p>
    </section>

    <section class="chart-card">
      <p class="title-main">
        Current metric:
        <span id="currentMetricLabel">Standard Accuracy</span>
      </p>
      <p class="title-secondary">
        X-axis: training / robustness approaches · Grouped bars: CIFAR-100, CIFAR-10, SVHN, MNIST · Y-axis: percentage (%).
      </p>

      <svg id="chart"></svg>

      <!-- 数据集图例 -->
      <div class="legend"></div>
    </section>

    <section class="notes">
      <h2>How to read this chart</h2>
      <ul>
        <li>The chart <strong>always uses all data from the Excel table</strong> – no rows or columns are dropped.</li>
        <li>You can switch between:
          <strong>Standard Accuracy</strong>,
          <strong>Certified Robustness Rate (CRR)</strong>,
          <strong>Certified Robust Accuracy (CRA)</strong>.
        </li>
        <li>For each metric category, the x-axis lists 9 approaches (ERM, DA, PGDT, TRADES, MART, RS, IBP, PRL, TandT).</li>
        <li>Within each approach, 4 blue bars show the performance on
          CIFAR-100, CIFAR-10, SVHN, and MNIST.
        </li>
        <li>Bars animate in from zero on page load (non-interaction transition) and smoothly update when you switch metrics.</li>
        <li>Hover any bar to see the exact value, dataset name, and approach.</li>
      </ul>
    </section>
  </main>

  <div id="tooltip" class="tooltip"></div>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // ---------- 基本布局 ----------
    const margin = { top: 36, right: 20, bottom: 70, left: 70 };
    const outerWidth = 960;
    const outerHeight = 520;
    const width = outerWidth - margin.left - margin.right;
    const height = outerHeight - margin.top - margin.bottom;

    // 三大类指标
    const metricModes = [
      {
        id: "Std",
        label: "Standard Accuracy",
        description: "Clean (standard) accuracy on each dataset."
      },
      {
        id: "CRR",
        label: "Certified Robustness Rate",
        description: "Percentage of samples that can be certified as robust."
      },
      {
        id: "CRA",
        label: "Certified Robust Accuracy",
        description: "Accuracy restricted to certifiably robust samples."
      }
    ];

    // 四个数据集
    const datasets = [
      { id: "CIFAR100", label: "CIFAR-100", color: "#9fd1ff" },
      { id: "CIFAR10",  label: "CIFAR-10",  color: "#6fb1ff" },
      { id: "SVHN",     label: "SVHN",     color: "#3d82f2" },
      { id: "MNIST",    label: "MNIST",    color: "#214070" }
    ];

    // 不同指标 → 对应列名
    const columnMap = {
      Std: {
        CIFAR100: "Std Acc - CIFAR100",
        CIFAR10:  "Std Acc - CIFAR10",
        SVHN:     "Std Acc - SVHN",
        MNIST:    "Std Acc - MNIST"
      },
      CRR: {
        CIFAR100: "CRR - CIFAR100",
        CIFAR10:  "CRR - CIFAR10",
        SVHN:     "CRR - SVHN",
        MNIST:    "CRR - MNIST"
      },
      CRA: {
        CIFAR100: "CRA - CIFAR100",
        CIFAR10:  "CRA - CIFAR10",
        SVHN:     "CRA - SVHN",
        MNIST:    "CRA - MNIST"
      }
    };

    const svg = d3.select("#chart")
      .attr("viewBox", `0 0 ${outerWidth} ${outerHeight}`)
      .attr("preserveAspectRatio", "xMidYMid meet");

    const chartArea = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const gridGroup = chartArea.append("g").attr("class", "grid");
    const xAxisGroup = chartArea.append("g").attr("class", "axis x-axis")
      .attr("transform", `translate(0,${height})`);
    const yAxisGroup = chartArea.append("g").attr("class", "axis y-axis");

    chartArea.append("text")
      .attr("class", "axis-label")
      .attr("x", width / 2)
      .attr("y", height + 52)
      .attr("text-anchor", "middle")
      .text("Training / Robustness Approach");

    chartArea.append("text")
      .attr("class", "axis-label")
      .attr("transform", "rotate(-90)")
      .attr("x", -height / 2)
      .attr("y", -50)
      .attr("text-anchor", "middle")
      .text("Percentage (%)");

    const x0 = d3.scaleBand().paddingInner(0.18).paddingOuter(0.08); // approach
    const x1 = d3.scaleBand().padding(0.12);                         // dataset within approach
    const y = d3.scaleLinear().range([height, 0]);

    const tooltip = d3.select("#tooltip");

    // ---------- 顶部：三大类指标按钮 ----------
    const metricToggle = d3.select("#metricToggle");
    metricToggle.selectAll("button")
      .data(metricModes)
      .enter()
      .append("button")
      .attr("type", "button")
      .attr("class", (d,i) => "metric-btn" + (i === 0 ? " active" : ""))
      .text(d => d.label)
      .on("click", (event, d) => {
        metricToggle.selectAll("button").classed("active", m => m.id === d.id);
        update(d.id);
      });

    // ---------- 图例：四个数据集 ----------
    const legend = d3.select(".legend");
    const legendItems = legend.selectAll(".legend-item")
      .data(datasets)
      .enter()
      .append("div")
      .attr("class", "legend-item");

    legendItems.append("span")
      .attr("class", "legend-swatch")
      .style("background-color", d => d.color);

    legendItems.append("span")
      .text(d => d.label);

    // ---------- 读取 CSV 并绘图 ----------
    d3.csv("results.csv").then(raw => {
      // 转数值
      raw.forEach(row => {
        for (const key in row) {
          if (key !== "Approach" && row[key] !== "" && row[key] != null) {
            row[key] = +row[key];
          }
        }
      });

      const approaches = raw.map(d => d.Approach);
      x0.domain(approaches).range([0, width]);
      x1.domain(datasets.map(ds => ds.id)).range([0, x0.bandwidth()]);
      y.domain([0, 100]); // 百分比

      // 坐标轴和网格
      xAxisGroup.call(d3.axisBottom(x0));
      xAxisGroup.selectAll("text")
        .attr("dy", "1.0em")
        .style("font-size", 12);

      yAxisGroup.call(
        d3.axisLeft(y)
          .ticks(5)
          .tickFormat(d => d + "%")
      );
      yAxisGroup.select(".domain").remove();

      gridGroup.call(
        d3.axisLeft(y)
          .ticks(5)
          .tickSize(-width)
          .tickFormat("")
      );
      gridGroup.select(".domain").remove();

      // 初次加载：Standard Accuracy，带非交互触发动画
      update("Std", true);

      function update(metricId, firstLoad = false) {
        const metricInfo = metricModes.find(m => m.id === metricId);
        d3.select("#currentMetricLabel").text(metricInfo.label);

        // 把数据展开成 (approach, dataset) 形式
        const flat = [];
        raw.forEach(row => {
          datasets.forEach(ds => {
            const colName = columnMap[metricId][ds.id];
            flat.push({
              id: row.Approach + "-" + ds.id,
              approach: row.Approach,
              datasetId: ds.id,
              datasetLabel: ds.label,
              metricId: metricId,
              metricLabel: metricInfo.label,
              value: row[colName],
              color: ds.color
            });
          });
        });

        const bars = chartArea.selectAll("rect.bar")
          .data(flat, d => d.id);

        const t = d3.transition()
          .duration(firstLoad ? 900 : 750)
          .ease(d3.easeCubicOut);

        // enter + update
        bars.enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", d => x0(d.approach) + x1(d.datasetId))
          .attr("width", x1.bandwidth())
          .attr("y", height)
          .attr("height", 0)
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("fill", d => d.color)
          .on("mousemove", (event, d) => {
            tooltip
              .style("opacity", 1)
              .style("transform", "translateY(0px)")
              .style("left", (event.pageX + 16) + "px")
              .style("top", (event.pageY - 28) + "px")
              .html(
                `<div class="tooltip-title">${d.metricLabel}</div>
                 <div><strong>${d.datasetLabel}</strong></div>
                 <div>Approach: <strong>${d.approach}</strong></div>
                 <div>Value: <strong>${d.value.toFixed(2)}%</strong></div>`
              );
          })
          .on("mouseleave", () => {
            tooltip
              .style("opacity", 0)
              .style("transform", "translateY(-4px)");
          })
          .merge(bars)
          .transition(t)
          .attr("x", d => x0(d.approach) + x1(d.datasetId))
          .attr("y", d => y(d.value))
          .attr("height", d => height - y(d.value))
          .attr("fill", d => d.color);

        // exit
        bars.exit()
          .transition(t)
          .attr("y", height)
          .attr("height", 0)
          .remove();
      }
    }).catch(err => {
      console.error("Error loading results.csv:", err);
    });
  </script>
</body>
</html>
